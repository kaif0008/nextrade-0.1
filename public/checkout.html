<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Checkout | NexTrade</title>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <style>
    :root {
      --primary: #4361ee;
      --secondary: #3f37c9;
      --accent: #f72585;
      --light: #f8f9fa;
      --dark: #212529;
      --success: #4BB543;
      --gradient: linear-gradient(135deg, #4361ee 0%, #3f37c9 100%);
    }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--light);
      margin: 0;
      padding: 2rem;
      color: var(--dark);
    }

    .checkout-container {
      max-width: 600px;
      margin: auto;
      background: white;
      padding: 2rem;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    }

    h2 {
      color: var(--primary);
      font-size: 1.8rem;
      margin-bottom: 1.5rem;
    }

    p strong {
      color: var(--dark);
    }

    #product-name {
      color: var(--secondary);
      font-weight: 600;
    }

    label {
      font-weight: 600;
      margin-top: 1.2rem;
      display: block;
      color: var(--dark);
    }

    input, textarea, select {
      width: 100%;
      padding: 0.8rem;
      margin-top: 0.5rem;
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 8px;
      font-family: 'Poppins', sans-serif;
      transition: all 0.3s ease;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
    }

    button {
      background: var(--gradient);
      color: white;
      padding: 1rem;
      margin-top: 1.8rem;
      width: 100%;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(67, 97, 238, 0.3);
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .success-message {
      color: var(--success);
      text-align: center;
      margin-top: 1rem;
      font-weight: 600;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 480px) {
      body {
        padding: 1rem;
      }
      
      .checkout-container {
        padding: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="checkout-container">
    <h2><i class="fas fa-shopping-bag"></i> Checkout</h2>
    <p><strong>Product:</strong> <span id="product-name"></span></p>
    <p><strong>Price:</strong> <span id="product-price"></span></p>

    <form id="checkout-form">
      <label>Shipping Address:</label>
      <textarea id="address" required></textarea>

      <label>Your Details:</label>
      <input type="text" id="name" placeholder="Full Name" required />
      <input type="email" id="email" placeholder="Email" required />
      <input type="tel" id="phone" placeholder="Phone Number" required />

      <label>Review:</label>
      <textarea id="review" placeholder="Write your review..."></textarea>

      <button type="submit" id="submit-btn">Pay Now</button>
      <div id="success-message" class="success-message"></div>
    </form>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get("id");
    const productName = urlParams.get("product");
    let productPrice = parseFloat(urlParams.get("price"));
    const productImage = urlParams.get("image") || 'https://source.unsplash.com/random/800x600?product';

    if (isNaN(productPrice)) {
      const cart = JSON.parse(localStorage.getItem('cart')) || [];
      const product = cart.find(item => item.id == productId);
      if (product) productPrice = product.price;
    }

    document.getElementById("product-name").textContent = productName || "Unknown Product";
    if (isNaN(productPrice) || productPrice <= 0) {
      document.getElementById("product-price").textContent = "Price not available";
      document.getElementById("submit-btn").disabled = true;
      alert("Invalid price. Please return to cart.");
    } else {
      document.getElementById("product-price").textContent = `â‚¹${productPrice.toFixed(2)}`;
    }

    document.getElementById("checkout-form").addEventListener("submit", async function(e) {
      e.preventDefault();

      const name = document.getElementById("name").value;
      const email = document.getElementById("email").value;
      const phone = document.getElementById("phone").value;
      const address = document.getElementById("address").value;
      const review = document.getElementById("review").value;
      const submitBtn = document.getElementById("submit-btn");
      const successMessage = document.getElementById("success-message");

      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

      try {
        // STEP 1: Create Razorpay order on server
        const orderRes = await fetch('/api/create-order', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ amount: productPrice * 100 }) // Amount in paise
        });

        if (!orderRes.ok) {
          const errorData = await orderRes.json();
          throw new Error(errorData.message || "Order creation failed");
        }

        const orderData = await orderRes.json();
        if (!orderData.id) {
          throw new Error("Order creation failed - no order ID returned");
        }

        // STEP 2: Get Razorpay key from server
        const keyRes = await fetch('/api/get-razorpay-key');
        if (!keyRes.ok) {
          throw new Error("Failed to get payment key");
        }
        const keyData = await keyRes.json();
        const razorpayKey = keyData.key;

        // STEP 3: Open Razorpay checkout
        const options = {
          key: razorpayKey, // Use the key from server response
          amount: orderData.amount,
          currency: "INR",
          name: "NexTrade",
          description: productName,
          image: "https://yourcdn.com/logo.png",
          order_id: orderData.id,
          handler: async function (response) {
            try {
              // STEP 4: Save order details
              const finalOrder = {
                productName,
                price: productPrice,
                quantity: 1,
                image: productImage,
                orderDate: new Date(),
                status: "Processing",
                paymentMethod: "Razorpay",
                paymentStatus: "Completed",
                razorpay_payment_id: response.razorpay_payment_id,
                razorpay_order_id: response.razorpay_order_id,
                razorpay_signature: response.razorpay_signature,
                address,
                customerName: name,
                email,
                phone,
                review,
              };

              const saveRes = await fetch('/api/orders', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(finalOrder)
              });

              if (!saveRes.ok) {
                throw new Error("Failed to save order");
              }

              const saveResult = await saveRes.json();
              if (!saveResult.success) {
                throw new Error(saveResult.message || "Failed to save order");
              }

              // Remove from cart
              const cart = JSON.parse(localStorage.getItem('cart')) || [];
              if (productId) {
                localStorage.setItem('cart', JSON.stringify(cart.filter(item => item.id != productId)));
              }

              successMessage.innerHTML = `<i class="fas fa-check-circle"></i> Payment successful! Redirecting...`;
              setTimeout(() => window.location.href = "orders.html", 2000);
            } catch (error) {
              console.error("Error in payment handler:", error);
              alert("Payment was successful but we encountered an issue saving your order. Please contact support.");
              submitBtn.disabled = false;
              submitBtn.innerHTML = 'Pay Now';
            }
          },
          prefill: { name, email, contact: phone },
          notes: {
            address: address,
            product: productName
          },
          theme: { color: "#4361ee" }
        };

        const razorpay = new Razorpay(options);
        razorpay.on('payment.failed', function(response) {
          alert(`Payment failed: ${response.error.description}`);
          submitBtn.disabled = false;
          submitBtn.innerHTML = 'Pay Now';
        });
        
        razorpay.open();
      } catch (error) {
        console.error("Checkout error:", error);
        alert(error.message || "Something went wrong. Please try again.");
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Pay Now';
      }
    });
  </script>
</body>
</html>